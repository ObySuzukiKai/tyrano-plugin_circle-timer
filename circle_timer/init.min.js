class TyranoPluginCircleTimerImage{constructor(t,e,a){this.width=e,this.height=a,this.pass=t,this.image=new Image}drawImage(t){const e=this;e.image.onload=function(){t.beginPath(),t.drawImage(this,0,0,4*e.width,4*e.height,0,0,e.width,e.height)},e.image.src=e.pass}}class TyranoPluginCircleTimer{constructor(t){$.convertColorByCO=(t=>t.replace(/^0x([\da-f]{6})$/i,"#$1"));const e=function(){let t=parseInt(tyrano.plugin.kag.config.scWidth),e=parseInt(tyrano.plugin.kag.config.scHeight);return e>=t?t/1280:e/720}();this.canvas_width=1280*e*parseFloat(t.scale),this.canvas_height=720*e*parseFloat(t.scale),this.scale=parseInt(t.scale)||1,this.name=t.name,this.layer=t.layer,this.fix=$.toBoolean(t.fix),this.time=parseInt(t.time),this.storage=t.storage,this.target=t.target,this.left=150,this.top=75,this.front_color=$.convertColorByCO(t.front_color),this.back_color=$.convertColorByCO(t.back_color),t.front_graphic&&"none"!==t.front_graphic?(this.front_graphic={pass:"./data/image/"+t.front_graphic},this.front_graphic.obj=new TyranoPluginCircleTimerImage(this.front_graphic.pass,canvas_width,canvas_height)):this.front_graphic=null,t.back_graphic&&"none"!==t.back_graphic?(this.back_graphic={pass:"./data/image/"+t.back_graphic},this.back_graphic.obj=new TyranoPluginCircleTimerImage(this.back_graphic.pass,canvas_width,canvas_height)):this.back_graphic=null,t.end_graphic&&"none"!==t.end_graphic?(this.end_graphic={pass:"./data/image/"+t.end_graphic},this.end_graphic.obj=new TyranoPluginCircleTimerImage(this.end_graphic.pass,canvas_width,canvas_height)):this.end_graphic=null,this.stroke_color="none"!=t.stroke_color?$.convertColorByCO(t.stroke_color):null,this.stroke_width=this.stroke_color?parseInt(t.stroke_width):null,this.rad=this.stroke_color?this.top-2*parseFloat(t.stroke_width):this.top,this.end_color=$.convertColorByCO(t.end_color),this.end_p="%"==[...t.end_p].pop()?parseInt(t.end_p.split("").filter(t=>"%"!=t).join("")):parseInt(t.end_p),this.canvas={name:`${this.name}_canvas`,left:`${parseInt(t.left)-this.canvas_width/2}px`,top:`${parseInt(t.top)-this.canvas_height/2}px`,width:`${this.canvas_width}px`,height:`${this.canvas_height}px`,zIndex:parseInt(t.zindex)},this.start=$.toBoolean(t.start),this.clear=$.toBoolean(t.clear),this.arc=-90,this.mode="set",this.interval_time=parseInt(t.start_time),this.loop=null,this.timeout=null,this.init=function(){this.setCanvas(),this.start||(this.mode="stop"),this.startInterval(),TYRANO.kag.stat.circle_timer_array.forEach(t=>{t.timer.name==this.name&&(t.tmp=this)})},console.log(this)}setCanvas(){this.fix?$("#tyrano_base").append(`<canvas id='${this.canvas.name}' class='fixlayer'></canvas>`):$(`.${this.layer}_fore`).append(`<canvas id='${this.canvas.name}'></canvas>`),$(`#${this.canvas.name}`).css({position:"absolute",left:this.canvas.left,top:this.canvas.top,width:this.canvas.width,height:this.canvas.height,zIndex:this.canvas.zIndex})}startInterval(){const t=this,e=document.getElementById(this.canvas.name);this.draw(e),t.loop=(()=>{e.getContext("2d").clearRect(0,0,this.canvas_width,this.canvas_height),t.interval_time+=25,t.arc=t.interval_time/t.time*360-90,TYRANO.kag.stat.circle_timer_array.forEach(e=>{e.timer.name==t.name&&(e.tmp=t)}),t.draw(e),t.arc<270&&"set"==t.mode?t.timeout=setTimeout(t.loop,25):"stop"!=t.mode&&t.endTimer()}),t.timeout=setTimeout(t.loop,25)}draw(t){this.front_graphic?this.drawCircleImage(t):this.drawCircle(t),this.back_graphic?this.drawArcImage(t):this.drawArc(t)}drawCircle(t){const e=t.getContext("2d");e.beginPath(),e.arc(this.left,this.top,this.rad,0*Math.PI/180,360*Math.PI/180,!1),this.interval_time/this.time>=this.end_p/100?this.end_graphic?(e.clip(),this.end_graphic.obj.drawImage(e)):(e.fillStyle=this.end_color&&"none"!==this.end_color?this.end_color:this.front_color,e.fill()):(e.fillStyle=this.front_color,e.fill()),this.stroke(e)}drawArc(t){const e=t.getContext("2d");e.fillStyle=this.back_color,e.beginPath(),e.moveTo(this.left,this.top),e.arc(this.left,this.top,this.rad+.1,-90*Math.PI/180,this.arc*Math.PI/180,!1),e.closePath(),e.fill(),this.stroke(e)}drawCircleImage(t){const e=t.getContext("2d");e.beginPath(),e.arc(this.left,this.top,this.rad,0*Math.PI/180,360*Math.PI/180,!1),e.clip(),this.front_graphic.obj.drawImage(e),this.stroke(e)}drawArcImage(t){const e=t.getContext("2d");e.beginPath(),e.moveTo(this.left,this.top),e.arc(this.left,this.top,this.rad+.1,-90*Math.PI/180,this.arc*Math.PI/180,!1),e.clip(),this.drawImage(e,"./data/bgimage/title.jpg"),this.stroke(e)}drawImage(t,e){const a=this.canvas_width,i=this.canvas_height,r=e,s=new Image;s.onload=function(){t.beginPath(),t.drawImage(this,0,0,4*a,4*i,0,0,a,i)},s.src=r}stroke(t){"none"!=this.stroke_color&&(t.strokeStyle=this.stroke_color,t.lineWidth=this.stroke_width,t.stroke())}endTimer(){this.clear&&this.deleteTimer(),"set"==this.mode&&tyrano.plugin.kag.ftag.startTag("jump",{storage:this.storage,target:this.target})}deleteTimer(){const t=this;document.getElementById(this.canvas.name).getContext("2d").clearRect(0,0,$("#tyrano_base").width(),$("#tyrano_base").height()),$(`#${t.canvas.name}`).remove(),TYRANO.kag.stat.circle_timer_array=TYRANO.kag.stat.circle_timer_array.filter(e=>e.timer.name!=t.name)}}tyrano.plugin.kag.tag.set_circle_timer={vital:["name"],pm:{layer:"0",fix:"false",time:3e3,start_time:0,left:parseInt(tyrano.plugin.kag.config.scWidth)/2,top:parseInt(tyrano.plugin.kag.config.scHeight)/2,scale:1,front_color:"blue",back_color:"gray",front_graphic:"none",back_graphic:"none",stroke_color:"none",stroke_width:5,end_color:"none",end_graphic:"none",end_p:"80%",start:"true",clear:"true",zindex:999},start:function(t){var e=this.kag;if(e.stat.circle_timer_array||(e.stat.circle_timer_array=[]),parseInt(t.time)<parseInt(t.start_time))return console.error("[ERROR] start_time is cannot be greater than time."),!1;e.stat.circle_timer_array.forEach(e=>{if(e.timer.name==t.name)return console.error(`[ERROR] ${t.name} is already registered`),!1}),e.stat.circle_timer_array.push({tmp:null,timer:new TyranoPluginCircleTimer(t)}),e.stat.circle_timer_array.forEach(e=>{e.timer.name==t.name&&e.timer.init()}),this.kag.ftag.nextOrder()}},tyrano.plugin.kag.tag.ctrl_circle_timer={vital:["name"],pm:{content:"start"},start:function(t){const e=this.kag.stat;e.circle_timer_array||(e.circle_timer_array=[]),e.circle_timer_array.forEach(e=>{if(t.name==e.timer.name){switch(t.content){case"time":t.interval_time&&(e.timer.interval_time=e.timer.time<=parseInt(t.interval_time)?e.timer.time:parseInt(t.interval_time)),t.max_time&&(e.timer.time=parseInt(t.max_time));break;case"stop":e.timer.mode="stop";break;case"start":"set"!=e.timer.mode&&(e.timer.mode="set",clearTimeout(e.timer.timeout),e.timer.startInterval());break;case"clear":e.timer.mode="clear";break;case"delete":e.timer.deleteTimer()}e.tmp=e.timer}}),this.kag.ftag.nextOrder()}},tyrano.plugin.kag.tag.make_circle_timer={start:function(t){var e=this.kag.stat;e.circle_timer_array||(e.circle_timer_array=[],this.kag.ftag.nextOrder());let a=e.circle_timer_array;e.circle_timer_array=[],a.forEach(t=>{let a=Object.keys(t.tmp),i={};a.forEach(e=>i[e]=t.timer[e]),e.circle_timer_array.push({tmp:null,timer:new TyranoPluginCircleTimer(i)}),e.circle_timer_array.forEach(t=>{t.timer.name==i.name&&(t.timer.interval_time=i.interval_time,t.timer.init())})}),this.kag.ftag.nextOrder()}},["set_circle_timer","ctrl_circle_timer","make_circle_timer"].forEach(t=>{tyrano.plugin.kag.ftag.master_tag[t]=object(tyrano.plugin.kag.tag[t]),tyrano.plugin.kag.ftag.master_tag[t].kag=TYRANO.kag});